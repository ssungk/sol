# Sol - RTMP Server Implementation

Go언어로 구현된 RTMP (Real-Time Messaging Protocol) 서버입니다.

## 프로젝트 구조

```
sol/
├── cmd/
│   └── main.go                    # 서버 진입점
├── internal/
│   └── sol/
│       ├── server.go             # 메인 서버 로직
│       └── sol.go                # 솔 인터페이스
├── pkg/
│   ├── amf/                      # AMF (Action Message Format) 인코딩/디코딩
│   │   ├── amf0_decoder.go
│   │   ├── amf_common.go
│   │   ├── amf_encoder.go
│   │   └── *_test.go
│   └── rtmp/                     # RTMP 프로토콜 구현
│       ├── basic_header.go       # RTMP 기본 헤더
│       ├── chunk.go              # 청크 구조
│       ├── session_event.go      # 세션 이벤트 타입 정의
│       ├── message.go            # 메시지 구조
│       ├── message_header.go     # 메시지 헤더
│       ├── message_reader.go     # 메시지 읽기 로직
│       ├── message_reader_context.go # 읽기 컨텍스트
│       ├── message_writer.go     # 메시지 쓰기 로직
│       ├── server.go             # RTMP 서버
│       ├── session.go            # 클라이언트 세션 관리
│       └── stream.go             # 스트림 관리
└── go.mod
```

## 주요 기능

### RTMP 프로토콜 지원
- **핸드셰이크**: RTMP C0/C1/C2/S0/S1/S2 핸드셰이크 구현
- **청크 스트림**: 가변 크기 청크를 통한 데이터 전송
- **메시지 타입**: 다양한 RTMP 메시지 타입 지원 (1-20번)

### 메시지 파싱
- **Fmt 0-3**: 모든 청크 헤더 포맷 지원
- **확장 타임스탬프**: 0xFFFFFF 이상의 타임스탬프 처리
- **청크 재조립**: 분할된 청크를 완전한 메시지로 재조립

### 스트림 관리 시스템
- **직접 참조**: session 객체를 직접 참조하여 성능 최적화
- **단순한 구조**: 복잡한 매니저 계층 없이 직접 관리
- **자동 정리**: 세션 종료 시 모든 스트림에서 자동 정리

### 스트리밍 기능
- **Publish**: 스트림 발행 (OBS, FFmpeg 등에서 푸시)
- **Play**: 스트림 재생 (플레이어에서 시청)
- **메타데이터**: onMetaData를 통한 스트림 정보 전송
- **GOP 캐시**: 키프레임 캐싱으로 새 시청자 즉시 재생
- **멀티캐스트**: 하나의 발행자, 다수의 시청자 지원

### AMF 지원
- **AMF0**: 액션스크립트 메시지 포맷 인코딩/디코딩
- **명령어 처리**: connect, createStream, publish, play 등

### 확장 명령어
- **FCPublish/FCUnpublish**: Adobe Flash Media Server 호환 명령어 (SRS 스타일)
- **releaseStream**: 스트림 해제
- **deleteStream**: 스트림 삭제

## 최근 수정사항

### 2025-07-31: 세션 검색 성능 최적화 (O(n) → O(1))
- **맵 구조 변경**: `map[*session]struct{}` → `map[string]*session`
- **성능 개선**: sessionId 검색을 O(n) → O(1)로 최적화
- **불필요한 순회 제거**: findSessionById에서 전체 맵 순회 제거
- **메모리 효율성**: 포인터 키 대신 string 키로 메모리 사용량 감소

### 2025-07-31: 세션 ID를 UUID 대신 포인터 주소값으로 변경
- **메모리 효율성**: UUID 생성 오버헤드 제거
- **단순함**: fmt.Sprintf("%p", session)으로 간단한 ID 생성
- **고유성 보장**: 포인터 주소값은 프로세스 내에서 고유함
- **UUID 제거**: crypto/rand, encoding/hex 의존성 제거

### 2025-07-31: 이벤트 시스템 정리 및 파일명 변경
- **불필요한 이벤트 제거**: ConnectionEstablished, ConnectionClosed, StreamCreated, ErrorOccurred 등 제거
- **핵심 이벤트만 유지**: 스트림 제어(Publish/Play), 데이터(Audio/Video/Meta), 시스템(Terminated) 이벤트
- **파일명 변경**: event.go → session_event.go로 더 명확한 네이밍
- **코드 간소화**: 불필요한 이벤트 핸들러 및 전송 로직 제거

### 2025-07-31: FCPublish/FCUnpublish SRS 호환성 개선
- **SRS 스타일 구현**: `_result` → `onFCPublish` 순서로 응답
- **중복 제거**: FCPublish에서 onStatus 중복 전송 문제 해결
- **역할 명확화**: FCPublish/FCUnpublish는 "예고" 명령어, publish는 실제 상태 변경
- **Adobe Flash 호환성**: 표준 Flash Media Server 응답 형식 준수

### 2025-07-31: 스트림 관리 구조 개선
- **session 객체 직접 참조**: SessionID 기반에서 session 객체 직접 참조로 변경
- **성능 최적화**: SessionID 조회 오버헤드 제거
- **StreamManager 제거**: 복잡한 매니저 계층 제거, 단순한 맵 기반 관리
- **RWMutex 제거**: 단순한 구조로 변경
- **안전한 정리**: CleanupSession 메서드로 명시적 세션 정리

### 2025-07-30: 메시지 파싱 버그 수정
- **Fmt2/Fmt3 헤더 처리**: 이전 헤더 정보를 올바르게 상속받도록 수정
- **헤더 업데이트 로직**: 모든 Fmt 타입에서 헤더 컨텍스트 업데이트
- **코드 정리**: unreachable code 제거 및 에러 메시지 개선

### 2025-07-30: RTMP 스트림 키 구조 개선
- **appname/streamkey 지원**: RTMP 표준에 맞는 `appname/streamkey` 구조 도입
- **connect 명령어 개선**: `app` 필드에서 appname 추출
- **충돌 방지**: 동일한 streamkey라도 다른 appname에서 사용 가능
- **full stream path**: 모든 스트림 관련 로직에서 `appname/streamkey` 조합 사용
- **세션 관리 개선**: appName 필드 추가 및 GetFullStreamPath() 메서드 제공

## 현재 구조 특징

### 단순한 설계
- **직접 관리**: map[string]*Stream으로 스트림 직접 관리
- **session 직접 참조**: publisher *session, players map[*session]struct{}
- **복잡성 제거**: StreamManager, RWMutex 등 복잡한 구조 제거

### 성능 최적화
- **O(1) 세션 검색**: sessionId를 키로 하는 맵으로 즉시 접근
- **메모리 효율**: 불필요한 이벤트 및 매니저 제거
- **빠른 브로드캐스트**: session 객체 직접 참조로 즉시 전송

### 안전성
- **명시적 정리**: CleanupSession으로 세션 종료 시 확실한 정리
- **자동 관리**: 세션 종료 시 모든 스트림에서 자동 제거
- **메모리 누수 방지**: 적절한 참조 해제 및 정리

## 사용법

```bash
# 서버 실행
go run cmd/main.go

# 테스트 실행
go test ./...

# 빌드
go build -o sol cmd/main.go
```

## 의존성

- Go 1.19+
- 표준 라이브러리만 사용 (외부 의존성 없음)

## 테스트

```bash
# OBS에서 스트림 푸시
rtmp://localhost:1935/live/stream_key

# FFmpeg으로 스트림 푸시
ffmpeg -i input.mp4 -c copy -f flv rtmp://localhost:1935/live/test_stream

# FFplay로 스트림 재생
ffplay rtmp://localhost:1935/live/test_stream
```

## 알려진 이슈

- 현재 AMF3 지원 제한적
- 대용량 스트림에서 메모리 사용량 최적화 필요
- 에러 복구 메커니즘 개선 필요

## 기여하기

1. 이슈 리포트는 GitHub Issues에
2. Pull Request 환영
3. 코딩 스타일: `gofmt` 사용
4. 테스트 코드 필수
5. git msg는 1줄로 작성
