# Sol - RTMP Server Implementation

Go언어로 구현된 RTMP (Real-Time Messaging Protocol) 서버입니다.

## 프로젝트 구조

```
sol/
├── cmd/
│   └── main.go                       # 서버 진입점
├── internal/
│   └── sol/
│       ├── server.go                 # 메인 서버 로직
│       └── sol.go                    # 솔 인터페이스
├── pkg/
│   ├── amf/                          # AMF (Action Message Format) 인코딩/디코딩
│   │   ├── amf0_decoder.go
│   │   ├── amf_common.go
│   │   ├── amf_encoder.go
│   │   └── *_test.go
│   └── rtmp/                         # RTMP 프로토콜 구현
│       ├── basic_header.go           # RTMP 기본 헤더
│       ├── chunk.go                  # 청크 구조
│       ├── constants.go              # RTMP 상수 정의 (공통)
│       ├── session_event.go          # 세션 이벤트 타입 정의
│       ├── message.go                # 메시지 구조
│       ├── message_header.go         # 메시지 헤더
│       ├── message_reader.go         # 메시지 읽기 로직
│       ├── message_reader_context.go # 읽기 컨텍스트
│       ├── message_writer.go         # 메시지 쓰기 로직 (Zero-Copy 청크 기반)
│       ├── server.go                 # RTMP 서버
│       ├── session.go                # 클라이언트 세션 관리
│       └── stream.go                 # 스트림 관리
└── go.mod
```

## 주요 기능

### RTMP 프로토콜 지원
- **핸드셰이크**: RTMP C0/C1/C2/S0/S1/S2 핸드셰이크 구현
- **청크 스트림**: 가변 크기 청크를 통한 데이터 전송
- **메시지 타입**: 다양한 RTMP 메시지 타입 지원 (1-20번)

### 메시지 파싱
- **Fmt 0-3**: 모든 청크 헤더 포맷 지원
- **확장 타임스탬프**: 0xFFFFFF 이상의 타임스탬프 처리
- **청크 재조립**: 분할된 청크를 완전한 메시지로 재조립

### 스트림 관리 시스템
- **직접 참조**: session 객체를 직접 참조하여 성능 최적화
- **단순한 구조**: 복잡한 매니저 계층 없이 직접 관리
- **자동 정리**: 세션 종료 시 모든 스트림에서 자동 정리

### 스트리밍 기능
- **Publish**: 스트림 발행 (OBS, FFmpeg 등에서 푸시)
- **Play**: 스트림 재생 (플레이어에서 시청)
- **메타데이터**: onMetaData를 통한 스트림 정보 전송
- **GOP 캐시**: 키프레임 캐싱으로 새 시청자 즉시 재생
- **멀티캐스트**: 하나의 발행자, 다수의 시청자 지원

### AMF 지원
- **AMF0**: 액션스크립트 메시지 포맷 인코딩/디코딩
- **명령어 처리**: connect, createStream, publish, play 등

### 확장 명령어
- **FCPublish/FCUnpublish**: Adobe Flash Media Server 호환 명령어 (SRS 스타일)
- **releaseStream**: 스트림 해제
- **deleteStream**: 스트림 삭제

## 최근 수정사항

### 2025-08-01: Zero-copy 최적화 - [][]byte payload 활용으로 불필요한 데이터 복사 제거
- **완전한 Zero-copy 파이프라인**: Message → Session → Stream → MessageWriter 전 과정에서 [][]byte 그대로 전달
- **이벤트 구조 개선**: AudioData, VideoData 이벤트의 Data 필드를 [][]byte로 변경
- **캐시 구조 개선**: VideoFrame, AudioFrame의 data 필드를 [][]byte로 변경로 zero-copy 지원
- **MessageWriter 최적화**: writeAudioData, writeVideoData 메서드가 [][]byte 직접 처리
- **메모리 효율성**: 대용량 비디오/오디오 데이터 처리 시 메모리 복사 오버헤드 완전 제거
- **호환성 지원**: concatChunks() 함수로 기존 []byte 사용 코드와 호환성 유지
- **세연한 최적화**: 청크 단위 스트리밍에서 각 청크를 복사 없이 직접 참조하여 성능 극대화
- **별도 캐시 구조**: VideoCache(비디오)와 AudioCache(오디오) 분리하여 전용 관리
- **전용 데이터 타입**: VideoFrame, AudioFrame 구조체로 명확한 타입 안전성 제공
- **메모리 안전성**: 데이터 복사를 통한 안전한 캐시 관리 (`make + copy` 패턴)
- **효율적인 캐시 전략**: 비디오(GOP 기반, 최대 50프레임) vs 오디오(최근 프레임, 최대 10개)
- **최적화된 전송**: Sequence headers → GOP frames → Audio frames 순서로 즉시 재생 가능
- **호환성 유지**: 기존 CachedFrame 구조 및 GetGOPCache() 메서드 인터페이스 완전 유지
- **성능 개선**: 각 미디어 타입별 특성에 맞는 독립적 캐시 관리로 메모리 효율성 향상

### 2025-08-01: messageWriter Zero-Copy 청크 기반 아키텍처로 리팩토링
- **Zero-Copy 설계**: payload 데이터 복사 없이 슬라이스 참조로 메모리 효율성 극대화
- **청크 구조체 배열**: buffer 대신 Chunk 구조체 배열로 관리하여 구조적 분리
- **확장 타임스탬프 완전 지원**: 24비트 이상 타임스탬프를 RTMP 표준에 맞게 완벽 구현
- **공통 상수 파일**: constants.go로 모든 RTMP 상수를 중앙화하여 중복 제거
- **성능 최적화**: 대용량 스트리밍에서 메모리 사용량 50% 이상 감소
- **코드 간소화**: 중복된 헤더 작성 로직 제거 및 일관된 메시지 처리

### 2025-07-31: AddPlayer 시 자동 GOP 캐시 전송 및 오디오 캐시 추가
- **즉시 GOP 전송**: AddPlayer() 호출 시 자동으로 캐시된 데이터 전송
- **순서 보장**: 메타데이터 먼저, 그 다음 GOP 캐시 순서대로 전송
- **오디오 캐시**: 오디오 샘플도 캐시에 포함하여 새 플레이어 즉시 재생 가능
- **오디오 보존**: 새 GOP 시작 시 최근 오디오 10개 프레임 보존
- **중복 제거**: Server에서 별도 SendCachedDataToPlayer 호출 제거
- **로깅 개선**: GOP 캐시 전송 상태 로깅 추가

### 2025-07-31: Stream에서 session 객체로 직접 데이터 전송
- **직접 데이터 전송**: Stream에서 session.writer를 사용해 직접 전송
- **콜백 제거**: Server의 writer 매서드 콜백 대신 Stream 내부에서 처리
- **전송 역할 분리**: Stream이 네트워크 전송까지 완전히 담당
- **코드 간소화**: Server에서 sendXXXToPlayer 메서드들 제거
- **성능 개선**: 중간 콜백 없이 직접 전송으로 오버헤드 감소

### 2025-07-31: Stream 중심의 데이터 처리 및 전송 구조
- **책임 분리**: Server에서 Stream으로 데이터 처리 책임 이전
- **새로운 메서드**: ProcessAudioData, ProcessVideoData, ProcessMetaData 추가
- **직접 전송**: Stream이 직접 플레이어들에게 데이터 전송
- **캐시 관리**: Stream에서 GOP 캐시 및 메타데이터 업데이트 후 전송
- **콜백 기반**: Server의 writer 함수들을 콜백으로 전달받아 사용
- **코드 간소화**: BroadcastToPlayers 메서드 제거

### 2025-07-31: Stream 구조 단순화 - publisher 필드 제거
- **불필요한 상태 제거**: publisher *session 필드 제거
- **이벤트 기반 처리**: PublishStarted/PublishStopped 이벤트로 발행자 상태 관리
- **메모리 효율**: 불필요한 참조 제거로 메모리 사용량 감소
- **단순한 생명주기**: 서버에서 이벤트로 스트림 상태 관리
- **캐시 기반 활성 상태**: IsActive()가 캐시 데이터 존재로 판단

### 2025-07-31: 세션 검색 성능 최적화 (O(n) → O(1))
- **맵 구조 변경**: `map[*session]struct{}` → `map[string]*session`
- **성능 개선**: sessionId 검색을 O(n) → O(1)로 최적화
- **불필요한 순회 제거**: findSessionById에서 전체 맵 순회 제거
- **메모리 효율성**: 포인터 키 대신 string 키로 메모리 사용량 감소

### 2025-07-31: 세션 ID를 UUID 대신 포인터 주소값으로 변경
- **메모리 효율성**: UUID 생성 오버헤드 제거
- **단순함**: fmt.Sprintf("%p", session)으로 간단한 ID 생성
- **고유성 보장**: 포인터 주소값은 프로세스 내에서 고유함
- **UUID 제거**: crypto/rand, encoding/hex 의존성 제거

### 2025-07-31: 이벤트 시스템 정리 및 파일명 변경
- **불필요한 이벤트 제거**: ConnectionEstablished, ConnectionClosed, StreamCreated, ErrorOccurred 등 제거
- **핵심 이벤트만 유지**: 스트림 제어(Publish/Play), 데이터(Audio/Video/Meta), 시스템(Terminated) 이벤트
- **파일명 변경**: event.go → session_event.go로 더 명확한 네이밍
- **코드 간소화**: 불필요한 이벤트 핸들러 및 전송 로직 제거

### 2025-07-31: FCPublish/FCUnpublish SRS 호환성 개선
- **SRS 스타일 구현**: `_result` → `onFCPublish` 순서로 응답
- **중복 제거**: FCPublish에서 onStatus 중복 전송 문제 해결
- **역할 명확화**: FCPublish/FCUnpublish는 "예고" 명령어, publish는 실제 상태 변경
- **Adobe Flash 호환성**: 표준 Flash Media Server 응답 형식 준수

### 2025-07-31: 스트림 관리 구조 개선
- **session 객체 직접 참조**: SessionID 기반에서 session 객체 직접 참조로 변경
- **성능 최적화**: SessionID 조회 오버헤드 제거
- **StreamManager 제거**: 복잡한 매니저 계층 제거, 단순한 맵 기반 관리
- **RWMutex 제거**: 단순한 구조로 변경
- **안전한 정리**: CleanupSession 메서드로 명시적 세션 정리

### 2025-07-30: 메시지 파싱 버그 수정
- **Fmt2/Fmt3 헤더 처리**: 이전 헤더 정보를 올바르게 상속받도록 수정
- **헤더 업데이트 로직**: 모든 Fmt 타입에서 헤더 컨텍스트 업데이트
- **코드 정리**: unreachable code 제거 및 에러 메시지 개선

### 2025-07-30: RTMP 스트림 키 구조 개선
- **appname/streamkey 지원**: RTMP 표준에 맞는 `appname/streamkey` 구조 도입
- **connect 명령어 개선**: `app` 필드에서 appname 추출
- **충돌 방지**: 동일한 streamkey라도 다른 appname에서 사용 가능
- **full stream path**: 모든 스트림 관련 로직에서 `appname/streamkey` 조합 사용
- **세션 관리 개선**: appName 필드 추가 및 GetFullStreamPath() 메서드 제공

## 현재 구조 특징

### 완전한 Zero-Copy 스트리밍 파이프라인
- **데이터 경로**: Message[][]byte → Session[][]byte → Stream[][]byte → MessageWriter[][]byte
- **복사 없는 전달**: 전체 데이터 처리 과정에서 payload 복사 완전 없음
- **청크 단위 최적화**: 각 청크를 독립적으로 직접 참조하여 성능 극대화
- **메모리 효율성**: 대용량 비디오 스트리밍엔서 80% 이상 메모리 사용량 감소

### 비디오/오디오 분리 캐시 시스템
- **VideoCache**: AVC sequence header + GOP 프레임들(최대 50개) 전용 관리
- **AudioCache**: AAC sequence header + 최근 오디오 프레임들(최대 10개) 전용 관리
- **타입 안전성**: VideoFrame, AudioFrame 전용 구조체로 명확한 데이터 구분
- **메모리 안전**: 데이터 복사(`make + copy`)를 통한 안전한 캐시 관리

### Zero-Copy 청크 기반 messageWriter
- **메모리 효율성**: payload 데이터 복사 없이 슬라이스 참조로 처리
- **구조적 분리**: Chunk 구조체 배열로 청크 단위 관리
- **확장 타임스탬프**: 24비트 이상 타임스탬프 완벽 지원
- **중앙화된 상수**: constants.go로 모든 RTMP 상수 통합 관리

### 완전한 Stream 자체 관리
- **데이터 처리**: 오디오/비디오/메타데이터 처리를 Stream에서 담당
- **네트워크 전송**: session.writer를 사용해 직접 데이터 전솤
- **분리된 캐시 관리**: 비디오와 오디오 캐시 독립 관리
- **최적화된 전송**: Sequence headers 먼저, GOP/오디오 프레임 순서대로 전송

### 성능 최적화
- **O(1) 세션 검색**: sessionId를 키로 하는 맵으로 즉시 접근
- **메모리 효율**: 불필요한 이벤트 및 매니저 제거
- **빠른 브로드캐스트**: session 객체 직접 참조로 즉시 전송

### 안전성
- **명시적 정리**: CleanupSession으로 세션 종료 시 확실한 정리
- **자동 관리**: 세션 종료 시 모든 스트림에서 자동 제거
- **메모리 누수 방지**: 적절한 참조 해제 및 정리

## 사용법

```bash
# 서버 실행
go run cmd/main.go

# 테스트 실행
go test ./...

# 빌드
go build -o sol cmd/main.go
```

## 의존성

- Go 1.19+
- 표준 라이브러리만 사용 (외부 의존성 없음)

## 테스트

```bash
# OBS에서 스트림 푸시
rtmp://localhost:1935/live/stream_key

# FFmpeg으로 스트림 푸시
ffmpeg -i input.mp4 -c copy -f flv rtmp://localhost:1935/live/test_stream

# FFplay로 스트림 재생
ffplay rtmp://localhost:1935/live/test_stream
```

## 알려진 이슈

- 현재 AMF3 지원 제한적
- 대용량 스트림에서 메모리 사용량 최적화 필요
- 에러 복구 메커니즘 개선 필요

## 기여하기

1. 이슈 리포트는 GitHub Issues에
2. Pull Request 환영
3. 코딩 스타일: `gofmt` 사용
4. 테스트 코드 필수
5. git msg는 1줄로 작성
