# Sol - RTMP Server Implementation

Go언어로 구현된 RTMP (Real-Time Messaging Protocol) 서버입니다.

## 프로젝트 구조

```
sol/
├── cmd/
│   └── main.go                    # 서버 진입점
├── internal/
│   └── sol/
│       ├── server.go             # 메인 서버 로직
│       └── sol.go                # 솔 인터페이스
├── pkg/
│   ├── amf/                      # AMF (Action Message Format) 인코딩/디코딩
│   │   ├── amf0_decoder.go
│   │   ├── amf_common.go
│   │   ├── amf_encoder.go
│   │   └── *_test.go
│   └── rtmp/                     # RTMP 프로토콜 구현
│       ├── basic_header.go       # RTMP 기본 헤더
│       ├── chunk.go              # 청크 구조
│       ├── event.go              # 이벤트 타입 정의
│       ├── message.go            # 메시지 구조
│       ├── message_header.go     # 메시지 헤더
│       ├── message_reader.go     # 메시지 읽기 로직
│       ├── message_reader_context.go # 읽기 컨텍스트
│       ├── message_writer.go     # 메시지 쓰기 로직
│       ├── server.go             # RTMP 서버
│       ├── session.go            # 클라이언트 세션 관리
│       └── stream.go             # 스트림 관리 (NEW!)
└── go.mod
```

## 주요 기능

### RTMP 프로토콜 지원
- **핸드셰이크**: RTMP C0/C1/C2/S0/S1/S2 핸드셰이크 구현
- **청크 스트림**: 가변 크기 청크를 통한 데이터 전송
- **메시지 타입**: 다양한 RTMP 메시지 타입 지원 (1-20번)

### 메시지 파싱
- **Fmt 0-3**: 모든 청크 헤더 포맷 지원
- **확장 타임스탬프**: 0xFFFFFF 이상의 타임스탬프 처리
- **청크 재조립**: 분할된 청크를 완전한 메시지로 재조립

### 스트림 관리 시스템
- **StreamManager**: 전체 스트림 관리 (생성, 삭제, 조회)
- **Stream**: 개별 스트림 상태 관리 (발행자, 플레이어, 캐시)
- **스레드 안전**: 모든 스트림 작업에 대한 동시성 보장
- **자동 정리**: 비활성 스트림 자동 삭제

### 스트리밍 기능
- **Publish**: 스트림 발행 (OBS, FFmpeg 등에서 푸시)
- **Play**: 스트림 재생 (플레이어에서 시청)
- **메타데이터**: onMetaData를 통한 스트림 정보 전송
- **GOP 캐시**: 키프레임 캐싱으로 새 시청자 즉시 재생
- **멀티캐스트**: 하나의 발행자, 다수의 시청자 지원

### AMF 지원
- **AMF0**: 액션스크립트 메시지 포맷 인코딩/디코딩
- **명령어 처리**: connect, createStream, publish, play 등

### 확장 명령어
- **FCPublish/FCUnpublish**: Adobe Flash Media Server 호환 명령어
- **releaseStream**: 스트림 해제
- **deleteStream**: 스트림 삭제

## 최근 수정사항

### 2025-07-30: 메시지 파싱 버그 수정
- **Fmt2/Fmt3 헤더 처리**: 이전 헤더 정보를 올바르게 상속받도록 수정
- **헤더 업데이트 로직**: 모든 Fmt 타입에서 헤더 컨텍스트 업데이트
- **코드 정리**: unreachable code 제거 및 에러 메시지 개선

### 2025-07-30: Stream 클래스 SessionID 기반 리팩토링
- **순환 의존성 제거**: Stream에서 session 객체 직접 참조 제거
- **SessionID 기반 관리**: publisherID, playerIDs로 sessionID만 저장
- **결합도 감소**: Stream이 session 구체적 구현에 의존하지 않음
- **메모리 누수 방지**: session 종료 시 자동 참조 해제
- **StreamManager 기능 향상**: session 조회 콜백 및 브로드캐스트 메서드 추가

### 2025-07-30: RTMP 스트림 키 구조 개선
- **appname/streamkey 지원**: RTMP 표준에 맞는 `appname/streamkey` 구조 도입
- **connect 명령어 개선**: `app` 필드에서 appname 추출
- **충돌 방지**: 동일한 streamkey라도 다른 appname에서 사용 가능
- **full stream path**: 모든 스트림 관련 로직에서 `appname/streamkey` 조합 사용
- **세션 관리 개선**: appName 필드 추가 및 GetFullStreamPath() 메서드 제공

### 2025-07-30: 스트림 관리 리팩토링
- **stream.go 분리**: 스트림 관리 로직을 별도 파일로 분리
- **StreamManager**: 중앙집중식 스트림 관리 시스템 도입
- **Stream 클래스**: 개별 스트림 상태 및 캐시 관리 개선
- **코드 모듈화**: server.go에서 스트림 관련 로직 분리로 가독성 향상
- **동시성 개선**: 스트림별 세밀한 락 관리

### 2025-07-30: FCUnpublish 기능 추가
- **handleFCUnpublish**: FCUnpublish 명령어 처리 추가
- **이벤트 시스템**: FCUnpublishReceived 이벤트 타입 추가
- **상태 관리**: publish 상태 정리 및 응답 전송

## 개발 중인 기능

- [ ] RTMPS (SSL/TLS) 지원
- [ ] H.264/AAC 코덱 최적화
- [ ] 스트림 녹화 기능
- [ ] 대역폭 제어
- [ ] 클러스터링 지원

## 사용법

```bash
# 서버 실행
go run cmd/main.go

# 테스트 실행
go test ./...

# 빌드
go build -o sol cmd/main.go
```

## 의존성

- Go 1.19+
- 표준 라이브러리만 사용 (외부 의존성 없음)

## 테스트

```bash
# OBS에서 스트림 푸시
rtmp://localhost:1935/live/stream_key

# FFmpeg으로 스트림 푸시
ffmpeg -i input.mp4 -c copy -f flv rtmp://localhost:1935/live/test_stream

# FFplay로 스트림 재생
ffplay rtmp://localhost:1935/live/test_stream
```

## 알려진 이슈

- 현재 AMF3 지원 제한적
- 대용량 스트림에서 메모리 사용량 최적화 필요
- 에러 복구 메커니즘 개선 필요

## 기여하기

1. 이슈 리포트는 GitHub Issues에
2. Pull Request 환영
3. 코딩 스타일: `gofmt` 사용
4. 테스트 코드 필수
